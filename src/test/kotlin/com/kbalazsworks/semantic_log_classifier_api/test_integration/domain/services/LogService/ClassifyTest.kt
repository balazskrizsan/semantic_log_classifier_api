package com.kbalazsworks.semantic_log_classifier_api.test_integration.domain.services.LogService

import com.kbalazsworks.semantic_log_classifier_api.AbstractTest
import com.kbalazsworks.semantic_log_classifier_api.db_presets.VectorStore384_Insert9rows_TypeLog
import com.kbalazsworks.semantic_log_classifier_api.domain.entities.VectorStoreX
import com.kbalazsworks.semantic_log_classifier_api.domain.entities.VectorStoreXSimilarity
import com.kbalazsworks.semantic_log_classifier_api.domain.services.LogService
import com.kbalazsworks.semantic_log_classifier_api.domain.value_objects.EmbeddingRequest
import com.kbalazsworks.semantic_log_classifier_api.fake_builders.VectorStore384FakeBuilder
import com.kbalazsworks.semantic_log_classifier_api.helpers.value_objects.GenericTestDataP2
import com.kbalazsworks.semantic_log_classifier_api.test_services.db_preset_service.SqlPreset
import com.pgvector.PGvector
import org.assertj.core.api.Assertions
import org.assertj.core.api.Assertions.assertThat
import org.junit.jupiter.api.Test
import org.junit.jupiter.params.ParameterizedTest
import org.junit.jupiter.params.provider.MethodSource

class ClassifyTest : AbstractTest() {
    companion object {
        @JvmStatic
        fun preparedEmbededAiDb_returnExpectedSimilarLogs_provider() = providerMap(
            GenericTestDataP2(
                testedData = EmbeddingRequest("User login problem"),
                expectedResponse = listOf(
                    VectorStoreXSimilarity(0.81292117F, VectorStore384FakeBuilder().build_realVector4()),
                ),
            ),
            GenericTestDataP2(
                testedData = EmbeddingRequest("Payment error"),
                expectedResponse = listOf(
                    VectorStoreXSimilarity(0.9760199F, VectorStore384FakeBuilder().build_realVector3()),
                ),
            ),
            GenericTestDataP2(
                testedData = EmbeddingRequest("AWS API error"),
                expectedResponse = listOf(
                    VectorStoreXSimilarity(1.0F, VectorStore384FakeBuilder().build_realVector7()),
                ),
            ),
            GenericTestDataP2(
                testedData = EmbeddingRequest("AWS connection timeout"),
                expectedResponse = listOf(
                    VectorStoreXSimilarity(
                        1.0F,
                        VectorStoreX(
                            1L,
                            1L,
                            mapOf("type" to "log", "text" to "AWS connection timeout"),
                            //@formatter:off
                            PGvector(listOf(0.060267497,0.05512238,-0.056220554,-1.8827373E-4,-0.040858753,-0.031274505,-0.044613626,-0.07174326,0.116571106,0.056281544,-6.160379E-5,0.035311233,-5.0977986E-5,-0.019906806,0.016905421,3.2253872E-4,-0.064274535,-0.07356258,-0.11773033,-0.03614665,-0.05434586,0.024135083,-0.066076286,0.044893112,-0.037401613,-0.0045555,-0.019862784,0.0028560131,0.0051319664,-0.009613358,-0.012513968,-0.037150916,-0.019259186,0.0015694264,0.038326684,0.020209577,0.034844577,0.04882914,-0.043659475,0.052290045,0.045111623,0.02101452,0.029557467,-0.015733885,0.04117039,0.03177143,0.081051625,-0.040932786,0.08782199,0.039803438,-0.03267387,0.054651838,-0.04192807,-0.01009373,-0.038222082,0.07405329,-0.003019806,0.045116965,-0.030376375,-0.02815542,0.041189566,-0.03907999,0.009497512,-0.0034301202,-0.05856923,0.011880428,0.06461414,-0.024232993,0.0029154695,0.051271435,-0.036156904,0.04595636,-0.12901253,0.055352103,0.039016854,0.048070285,0.111185305,-0.04084485,0.10159723,-0.0049489397,-0.03899406,0.019611524,-0.09550338,4.4941064E-4,-0.041278757,-0.072463624,0.072448075,0.02967719,-0.051612865,0.012983465,-0.0055527342,-0.051500462,0.0029312307,0.042613536,-0.016398078,0.018047363,0.04939417,0.0402963,-0.057815608,-0.021082018,0.045837242,0.006718234,-0.045702215,0.013425933,0.015637243,0.002324858,0.006412087,0.059836965,0.024476033,-0.0019197223,0.0070835245,-0.044231106,0.03582684,0.03589825,-0.0037706567,0.00662077,-0.07385644,-0.030600136,0.026999902,0.074812956,0.06351124,-0.009781249,0.044619,-0.1166541,-0.048082434,0.05096775,0.03972374,7.726292E-34,-0.048887562,-0.021892883,-0.0295332,-0.012922808,0.07222633,-0.007669706,-0.073546626,0.012999508,-1.2214617E-4,-0.0045807823,-0.11011001,-0.12081207,-0.046097357,-0.06833763,-0.024419792,0.01790887,0.057522226,0.008449046,0.026257623,0.052019075,0.042296123,-0.14626585,0.012530968,-0.017516071,0.046360273,0.021834025,0.0055523445,-0.0035744568,0.061003245,0.009762884,0.047723334,0.05294777,-0.034004528,-0.09620522,0.04322147,-0.067577116,0.034087524,0.013136501,0.020501604,0.013216902,-0.02489398,-0.021404484,-0.059884883,0.08113249,0.01591362,0.04349383,0.0401201,0.0078912405,-0.02591946,0.07219215,-0.08613604,-0.019019626,0.018830827,0.0036697022,0.039750222,0.041101336,-0.023898767,-0.014477914,-0.07916706,-0.012021499,-0.013330706,0.04446965,-0.014144191,-0.0064968294,0.08786452,0.04623975,-0.040573746,0.050693937,-0.026822502,0.027946854,0.008015688,0.05267787,0.10091983,0.0034240647,-0.08625957,-0.10725045,-0.0042906534,-0.0425609,-0.017635722,0.04174825,-0.05551649,-0.005758191,-0.016234834,-0.008915194,-0.113557704,-0.00202813,0.023971701,0.021103883,0.0077424743,0.02209282,-0.10957784,0.045063373,0.06975054,-0.10227763,-0.05971786,3.1079024E-34,-0.05801366,-0.051963236,-0.0041948156,0.0019150857,0.11212293,-0.027009284,0.028492676,0.14984865,-0.011396248,0.029228305,0.09788711,0.010476656,0.026036749,-0.115542665,-0.02687121,-0.06589546,0.055574574,-0.034749687,0.0757709,0.0055407765,0.045094308,-0.056227498,0.024743143,-0.07820056,0.022874841,0.036840905,-0.06777784,-0.018264813,-0.019191021,-0.0221647,0.048642203,0.055864163,-0.03552507,0.091590896,-0.034873493,0.03665022,0.0063769347,0.056230742,-0.009284865,-0.06981126,0.07263849,0.0023705852,-0.012526191,-0.0027128104,0.012490107,0.07671631,-0.026357928,0.0036482818,-0.07074539,0.034745358,-0.063535936,-0.040074594,0.04639119,0.1087212,0.04388675,0.012332263,-0.010346231,-0.031962845,0.010940762,0.061432283,0.0013813081,-0.06418524,0.036776282,0.008662739,0.09730344,-0.01355085,0.007671753,0.03135837,0.11119151,0.07371077,0.019566126,0.031362914,0.013983252,-0.022242222,-0.031437565,0.05105666,-0.10628232,-0.076136746,-0.04087524,-0.004899563,-0.038632758,0.09063167,-0.08944266,-0.035756685,0.08976322,0.11305028,-0.013159024,0.087080084,0.04928865,0.05871553,-0.090513706,-0.038105205,-0.05755398,0.016705066,-0.0936714,-1.3113266E-8,0.040730946,0.02337483,0.02380569,-0.038694862,0.04107731,0.081108555,-0.02361079,-0.04046046,-0.02326424,-0.0068622,0.008789333,-0.0067975717,-0.026489781,0.06603043,0.007816231,-0.060194347,0.007009925,-0.0127020925,0.029222742,-0.031643983,-0.0047513535,-0.04571422,-0.060610894,0.005091039,-0.050530005,0.017500315,0.01354506,0.03657825,-0.06728742,-0.009218965,-0.08687853,-1.0027507E-4,-0.026808575,0.03176506,-0.020054452,-0.09420569,-0.08421894,-0.02976645,-0.09562712,0.02772784,0.06312417,0.02138088,0.03481092,-0.0010598911,0.089455724,0.039217956,0.016333498,0.12877883,-0.023058722,0.06755222,0.009293551,-0.07136644,-0.03815323,0.008266522,0.09069699,-0.033154264,0.09834615,-0.055405997,-0.011614794,0.023999443,-0.05348517,0.040752076,-0.06817219,0.010775874))
                            //@formatter:on
                        )
                    )
                ),
            ),
        )
    }

    @ParameterizedTest
    @MethodSource("preparedEmbededAiDb_returnExpectedSimilarLogs_provider")
    @SqlPreset(presets = [VectorStore384_Insert9rows_TypeLog::class])
    fun preparedEmbededAiDb_returnExpectedSimilarLogs(td: GenericTestDataP2<EmbeddingRequest, List<VectorStoreXSimilarity>>) {
        // Arrange
        // Act
        val actual = createInstance(LogService::class.java).classify(td.testedData)

        // Assert
        Assertions.assertThat(actual).isEqualTo(td.expectedResponse)
    }

    @Test
    @SqlPreset(presets = [VectorStore384_Insert9rows_TypeLog::class])
    fun embeddingNotExistingLog_savingToDbAndReturnTheRecord() {
        // Arrange
        val testedRequest = EmbeddingRequest("AWS connection timeout")
        val expected = listOf<VectorStoreXSimilarity>(
            VectorStoreXSimilarity(
                1.0F, VectorStoreX(
                    1L,
                    1L,
                    mapOf("type" to "log", "text" to "AWS connection timeout"),
                    //@formatter:off
                    PGvector(listOf(0.060267497,0.05512238,-0.056220554,-1.8827373E-4,-0.040858753,-0.031274505,-0.044613626,-0.07174326,0.116571106,0.056281544,-6.160379E-5,0.035311233,-5.0977986E-5,-0.019906806,0.016905421,3.2253872E-4,-0.064274535,-0.07356258,-0.11773033,-0.03614665,-0.05434586,0.024135083,-0.066076286,0.044893112,-0.037401613,-0.0045555,-0.019862784,0.0028560131,0.0051319664,-0.009613358,-0.012513968,-0.037150916,-0.019259186,0.0015694264,0.038326684,0.020209577,0.034844577,0.04882914,-0.043659475,0.052290045,0.045111623,0.02101452,0.029557467,-0.015733885,0.04117039,0.03177143,0.081051625,-0.040932786,0.08782199,0.039803438,-0.03267387,0.054651838,-0.04192807,-0.01009373,-0.038222082,0.07405329,-0.003019806,0.045116965,-0.030376375,-0.02815542,0.041189566,-0.03907999,0.009497512,-0.0034301202,-0.05856923,0.011880428,0.06461414,-0.024232993,0.0029154695,0.051271435,-0.036156904,0.04595636,-0.12901253,0.055352103,0.039016854,0.048070285,0.111185305,-0.04084485,0.10159723,-0.0049489397,-0.03899406,0.019611524,-0.09550338,4.4941064E-4,-0.041278757,-0.072463624,0.072448075,0.02967719,-0.051612865,0.012983465,-0.0055527342,-0.051500462,0.0029312307,0.042613536,-0.016398078,0.018047363,0.04939417,0.0402963,-0.057815608,-0.021082018,0.045837242,0.006718234,-0.045702215,0.013425933,0.015637243,0.002324858,0.006412087,0.059836965,0.024476033,-0.0019197223,0.0070835245,-0.044231106,0.03582684,0.03589825,-0.0037706567,0.00662077,-0.07385644,-0.030600136,0.026999902,0.074812956,0.06351124,-0.009781249,0.044619,-0.1166541,-0.048082434,0.05096775,0.03972374,7.726292E-34,-0.048887562,-0.021892883,-0.0295332,-0.012922808,0.07222633,-0.007669706,-0.073546626,0.012999508,-1.2214617E-4,-0.0045807823,-0.11011001,-0.12081207,-0.046097357,-0.06833763,-0.024419792,0.01790887,0.057522226,0.008449046,0.026257623,0.052019075,0.042296123,-0.14626585,0.012530968,-0.017516071,0.046360273,0.021834025,0.0055523445,-0.0035744568,0.061003245,0.009762884,0.047723334,0.05294777,-0.034004528,-0.09620522,0.04322147,-0.067577116,0.034087524,0.013136501,0.020501604,0.013216902,-0.02489398,-0.021404484,-0.059884883,0.08113249,0.01591362,0.04349383,0.0401201,0.0078912405,-0.02591946,0.07219215,-0.08613604,-0.019019626,0.018830827,0.0036697022,0.039750222,0.041101336,-0.023898767,-0.014477914,-0.07916706,-0.012021499,-0.013330706,0.04446965,-0.014144191,-0.0064968294,0.08786452,0.04623975,-0.040573746,0.050693937,-0.026822502,0.027946854,0.008015688,0.05267787,0.10091983,0.0034240647,-0.08625957,-0.10725045,-0.0042906534,-0.0425609,-0.017635722,0.04174825,-0.05551649,-0.005758191,-0.016234834,-0.008915194,-0.113557704,-0.00202813,0.023971701,0.021103883,0.0077424743,0.02209282,-0.10957784,0.045063373,0.06975054,-0.10227763,-0.05971786,3.1079024E-34,-0.05801366,-0.051963236,-0.0041948156,0.0019150857,0.11212293,-0.027009284,0.028492676,0.14984865,-0.011396248,0.029228305,0.09788711,0.010476656,0.026036749,-0.115542665,-0.02687121,-0.06589546,0.055574574,-0.034749687,0.0757709,0.0055407765,0.045094308,-0.056227498,0.024743143,-0.07820056,0.022874841,0.036840905,-0.06777784,-0.018264813,-0.019191021,-0.0221647,0.048642203,0.055864163,-0.03552507,0.091590896,-0.034873493,0.03665022,0.0063769347,0.056230742,-0.009284865,-0.06981126,0.07263849,0.0023705852,-0.012526191,-0.0027128104,0.012490107,0.07671631,-0.026357928,0.0036482818,-0.07074539,0.034745358,-0.063535936,-0.040074594,0.04639119,0.1087212,0.04388675,0.012332263,-0.010346231,-0.031962845,0.010940762,0.061432283,0.0013813081,-0.06418524,0.036776282,0.008662739,0.09730344,-0.01355085,0.007671753,0.03135837,0.11119151,0.07371077,0.019566126,0.031362914,0.013983252,-0.022242222,-0.031437565,0.05105666,-0.10628232,-0.076136746,-0.04087524,-0.004899563,-0.038632758,0.09063167,-0.08944266,-0.035756685,0.08976322,0.11305028,-0.013159024,0.087080084,0.04928865,0.05871553,-0.090513706,-0.038105205,-0.05755398,0.016705066,-0.0936714,-1.3113266E-8,0.040730946,0.02337483,0.02380569,-0.038694862,0.04107731,0.081108555,-0.02361079,-0.04046046,-0.02326424,-0.0068622,0.008789333,-0.0067975717,-0.026489781,0.06603043,0.007816231,-0.060194347,0.007009925,-0.0127020925,0.029222742,-0.031643983,-0.0047513535,-0.04571422,-0.060610894,0.005091039,-0.050530005,0.017500315,0.01354506,0.03657825,-0.06728742,-0.009218965,-0.08687853,-1.0027507E-4,-0.026808575,0.03176506,-0.020054452,-0.09420569,-0.08421894,-0.02976645,-0.09562712,0.02772784,0.06312417,0.02138088,0.03481092,-0.0010598911,0.089455724,0.039217956,0.016333498,0.12877883,-0.023058722,0.06755222,0.009293551,-0.07136644,-0.03815323,0.008266522,0.09069699,-0.033154264,0.09834615,-0.055405997,-0.011614794,0.023999443,-0.05348517,0.040752076,-0.06817219,0.010775874))
                    //@formatter:on
                )
            )
        )

        // Act
        val actual = createInstance(LogService::class.java).classify(testedRequest)

        // Assert
        assertThat(actual).isEqualTo(expected)
    }
}
